<!DOCTYPE html>
<html>
    <head>
    <title>CubeRunner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.js"></script>
    <script src="http://learningthreejs.com/data/THREEx/THREEx.KeyboardState.js"></script>
    <!--<script src="meshnum.js"></script>-->
    </head>
    <body>
<script>
var meshnum = 5;
var keyboard = new THREEx.KeyboardState();
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

var renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

var geometries = [];
var materials = [];
for(var i = 0;i < meshnum; i ++){
geometries.push(new THREE.BoxGeometry(1, 3, 0.75));
materials.push(new THREE.MeshPhongMaterial( { color: 0x000000, specular: 0x666666, emissive: 0xf5f5f5, ambient: 0x000000, shininess: 10, shading: THREE.SmoothShading, opacity: 0, transparent: true } ))
}

var meshes = [];
var transes = [];
for(var i = 0;i < geometries.length;i++){
meshes.push(new THREE.Mesh(geometries[i], materials[i]));
// meshes[i].position.set(2, 0, (i*(20/meshnum))-15);
meshes[i].position.set((Math.random() * 10) -5, 0, -(i*(15/meshnum))-15);
scene.add(meshes[i]);
transes.push(0);
}

var dead = false;
var mult = 0.005;
var time = new Date();
var now = new Date();
function render() {
  renderer.render(scene, camera);
  // delta in ms
  var newTime = new Date();
  var delta = newTime - time;
  time = newTime;
  if(dead == false){
    mult = (new Date()-now)/2500000;
    mult+=0.005;
  }
  // move the boxes
  for(var i = 0;i<meshes.length;i++){
    meshes[i].position.z += delta * mult;
    transes[i] = (-meshes[i].position.z)/(-(i*(15/meshnum))-15);
    meshes[i].material.opacity = 1-(Math.abs(transes[i]));
  }
  
  if( keyboard.pressed("left") && camera.position.x >= -4.85)     camera.position.x-=0.15;
  if( keyboard.pressed("right") && camera.position.x <= 4.85 )     camera.position.x+=0.15;
  if( keyboard.pressed("up") )     mult+=0.0005;
  if( keyboard.pressed("down") && mult > 0.001)     mult-=0.0005;
  for(var i = 0;i<meshes.length;i++){
    if(camera.position.x >= meshes[i].position.x-0.75 && camera.position.x <= meshes[i].position.x+0.75){
      if(meshes[i].position.z <= 0 && meshes[i].position.z >= -1){
        meshes[i].material = new THREE.MeshPhongMaterial( { color: 0xFF3300, specular: 0xFF3300, emissive: 0xFF3300, ambient: 0xFF3300, shininess: 10, shading: THREE.SmoothShading, opacity: 0, transparent: true } );
        dead = true;
        renderer.setClearColor( 0x000000, 0 );
      }
    }
  }
  
  if(dead == true && mult > 0){
    mult-=0.0003
    if(mult < 0){
      mult = 0;
    }
  }
  // mult+=delta
/*  material1 = new THREE.MeshNormalMaterial({
  color: 'rgb(245, 245, 245)', transparent: true, opacity: trans1
});
  material2 = new THREE.MeshNormalMaterial({
  color: 'rgb(245, 245, 245)', transparent: true, opacity: trans2
});

meshes = [];

scene = new THREE.Scene();
meshes.push(new THREE.Mesh(geometries[0], material2));
meshes.push(new THREE.Mesh(geometries[1], material1));

meshes[0].position.set(2, 0, -10);
scene.add(meshes[0]);

meshes[1].position.set(-2, 0, -15);
scene.add(meshes[1]);*/
  if(true){
    for(var i = 0;i<meshes.length;i++){
      if(meshes[i].position.z >= 0){
        meshes[i].position.set((Math.random() * 10) -5, 0, -(i*(15/meshnum))-15);
        meshes[i].material.opacity = 0;
      }
    }
  }
  

  requestAnimationFrame(render);
};

requestAnimationFrame(render);
</script>
</body>
</html>
